# 环境检测系统升级

## 概述

环境检测系统升级是 fileChunkPro 3.0 版本的重要特性，为上传库提供了更全面、更精确的环境检测和适配能力。通过增强的环境检测系统，fileChunkPro 能够根据当前运行环境的特性和能力，自动选择最佳的配置参数，提高上传性能和成功率。

升级后的环境检测系统包含四个核心功能：

1. **详细特性检测**：全面检测各种环境特性支持情况
2. **能力评估算法**：评估设备的处理能力、内存容量、网络质量等
3. **配置推荐引擎**：根据评估结果自动推荐最优配置
4. **降级策略设计**：在关键特性不支持时提供可靠的降级方案

## 核心模块

### 1. EnvironmentDetectionSystem（环境检测系统）

**主要职责**：

- 检测当前运行环境（浏览器、小程序、Node.js等）
- 详细检测各种特性支持情况
- 评估设备各项能力
- 生成降级策略

**关键方法**：

- `detectAllFeatures()`: 检测所有环境特性
- `evaluateDeviceCapabilities()`: 评估设备能力
- `getRecommendedUploadStrategy()`: 获取推荐上传策略
- `getFallbackStrategies()`: 获取降级策略

### 2. ConfigurationEngine（配置推荐引擎）

**主要职责**：

- 基于环境检测结果生成推荐配置
- 为不同大小的文件生成不同的最优配置
- 尊重用户自定义配置偏好
- 提供环境能力报告

**关键方法**：

- `generateRecommendedConfig()`: 生成推荐配置
- `getRecommendedChunkSize()`: 获取推荐分片大小
- `getRecommendedConcurrency()`: 获取推荐并发数
- `generateCapabilityReport()`: 生成能力报告

### 3. 增强的 EnvUtils（环境工具类）

**主要职责**：

- 提供便捷的环境检测和配置推荐API
- 维护环境检测系统和配置引擎的单例
- 向后兼容原有API

**关键方法**：

- `getEnvSystem()`: 获取环境检测系统实例
- `getConfigEngine()`: 获取配置推荐引擎实例
- `getRecommendedConfig()`: 获取推荐配置
- `getCapabilityReport()`: 获取能力报告

## 详细特性检测

升级后的系统可以检测以下特性：

### 浏览器环境

- Web Worker 支持
- Service Worker 支持
- IndexedDB 支持
- File API 支持
- Streams API 支持
- WebCrypto API 支持
- SharedArrayBuffer 支持
- Network Information API 支持
- Performance API 和 Memory API 支持
- Battery API 支持
- 硬件并发支持
- 设备内存 API 支持

### 小程序环境

- 文件系统 API 支持
- 上传/下载 API 支持
- WebSocket 支持
- Worker 支持 (微信小程序)

### React Native 环境

- Fetch API 支持
- XMLHttpRequest 支持
- WebSocket 支持
- 文件系统支持

### Node.js 环境

- fs 模块支持
- http/https 模块支持
- stream 模块支持
- worker_threads 模块支持
- crypto 模块支持

## 能力评估算法

系统会评估设备的以下能力：

### 内存能力

- 使用 performance.memory 或 navigator.deviceMemory API
- 分为极低、低、中等、高、极高五个级别
- 内存容量影响分片大小和并发数推荐

### 处理器能力

- 使用硬件并发数或简单性能测试评估
- 分为低、中、高三个级别
- 处理器能力影响并发数和是否使用 Worker

### 网络能力

- 使用 Network Information API 或经验估计
- 分为极差、差、中等、良好、优秀五个级别
- 网络能力影响并发数、超时时间和重试策略

### 存储能力

- 检查 IndexedDB 支持和存储估计 API
- 分为低、中、高三个级别
- 存储能力影响断点续传策略

### 电池状态

- 使用 Battery API 评估
- 分为低、中、高三个级别
- 电池状态低时会减少资源使用

## 配置推荐引擎

配置推荐引擎根据环境检测结果和文件大小，为上传任务生成最优配置：

### 分片大小推荐

- 小文件（<5MB）：建议使用较小分片（~512KB）
- 中等文件（5-100MB）：建议使用中等分片（1-2MB）
- 大文件（>100MB）：建议使用较大分片（5-10MB）
- 根据内存、处理器和网络能力调整

### 并发数推荐

- 基于处理器核心数和网络质量
- 低网络质量环境降低并发数
- 高性能设备增加并发数
- 电池电量低时减少并发数

### 超时和重试策略

- 网络质量差时增加超时时间和重试次数
- 网络质量好时减少超时时间和重试次数
- 大文件增加一次额外重试
- 根据分片大小调整超时时间

### Worker 使用策略

- 检查 Worker 支持情况
- 低性能设备不使用 Worker
- 大文件（>20MB）建议使用 Worker
- 处理器能力高时优先使用 Worker

## 降级策略设计

当环境不支持某些关键特性时，系统会自动应用降级策略：

### Worker 降级

- 不支持 Worker 时，使用主线程处理
- 警告用户可能的界面卡顿问题

### 存储降级

- 不支持 IndexedDB 时，降级使用 localStorage
- 限制断点续传功能的文件大小

### 流式处理降级

- 不支持 Streams API 时，使用传统方式处理文件
- 限制超大文件的处理能力

### 加密降级

- 不支持 WebCrypto API 时，使用 JS 实现哈希计算
- 性能会降低，但保证功能可用

## 能力评分系统

为了更精确地评估不同环境的能力，我们引入了能力评分系统：

### 评分项目

- **总体评分**：综合所有因素的加权评分 (0-100)
- **文件处理能力**：评估文件处理相关特性和性能
- **网络能力**：评估网络相关特性和质量
- **并发处理能力**：评估并发处理相关特性和性能
- **存储能力**：评估存储相关特性和容量
- **可靠性**：评估系统稳定性和错误恢复能力

### 评分应用

- 评分结果用于生成不同级别的配置建议
- 提供性能、稳定性、省电模式等不同配置套餐
- 根据评分自动选择最适合当前环境的降级策略

## 多层次配置套餐

为适应不同使用场景，配置引擎提供五种配置套餐：

1. **平衡配置**：适合大多数场景，平衡性能与稳定性
2. **性能优先**：追求最高上传速度，适合网络良好的场景
3. **稳定性优先**：增加重试和容错机制，适合网络不稳定场景
4. **省电模式**：减少资源使用，适合移动设备电量低场景
5. **流量节省**：优化请求数量，适合流量受限场景

## 网络质量自适应

系统能根据网络质量动态调整配置：

- **极差网络**：最小分片，单线程上传，最长超时
- **良好网络**：中等分片，多线程上传，标准超时
- **优秀网络**：最大分片，最高并发，短超时
- **离线状态**：自动暂停上传，等待网络恢复

## 使用示例

```typescript
import { UploaderCore } from 'fileChunkPro';
import { EnvUtils } from 'fileChunkPro/utils';

// 1. 获取环境信息
const envName = EnvUtils.getEnvironmentName();
console.log(`当前环境: ${envName}`);

// 2. 检查特性支持
const hasWorker = EnvUtils.hasFeature('web_worker');
console.log(`Worker支持: ${hasWorker ? '是' : '否'}`);

// 3. 获取设备能力
const capabilities = EnvUtils.getDeviceCapabilities();
console.log('设备能力:', capabilities);

// 4. 获取推荐配置
const fileSize = 100 * 1024 * 1024; // 100MB
const config = EnvUtils.getRecommendedConfig(fileSize);
console.log('推荐配置:', config);

// 5. 创建上传器实例并使用推荐配置
const uploader = new UploaderCore({
  endpoint: 'https://example.com/upload',
  ...config,
});

// 6. 获取完整能力报告
const report = EnvUtils.getCapabilityReport();
console.log('环境能力报告:', report);
```

## 高级使用示例

### 获取不同配置套餐

```typescript
import { EnvUtils } from 'fileChunkPro/utils';

const fileSize = 50 * 1024 * 1024; // 50MB
const configEngine = EnvUtils.getConfigEngine();

// 获取所有配置套餐
const configs = configEngine.generateTieredConfigurations(fileSize);

// 使用不同套餐
console.log('平衡配置:', configs.balanced);
console.log('性能优先:', configs.performance);
console.log('稳定性优先:', configs.stability);
console.log('省电模式:', configs.powerSaving);
console.log('流量节省:', configs.dataSaving);
```

### 根据网络质量调整配置

```typescript
import { EnvUtils } from 'fileChunkPro/utils';
import { NetworkQuality } from 'fileChunkPro/types';

const fileSize = 50 * 1024 * 1024; // 50MB
const configEngine = EnvUtils.getConfigEngine();

// 获取不同网络质量下的配置
const poorNetworkConfig = configEngine.getNetworkQualityBasedConfig(
  NetworkQuality.POOR,
  fileSize
);

const goodNetworkConfig = configEngine.getNetworkQualityBasedConfig(
  NetworkQuality.GOOD,
  fileSize
);

// 根据实际网络质量选择配置
const currentNetworkQuality = getCurrentNetworkQuality(); // 自定义函数
const config = configEngine.getNetworkQualityBasedConfig(
  currentNetworkQuality,
  fileSize
);
```

## 测试覆盖

为确保环境检测系统的可靠性，我们编写了全面的单元测试：

1. 环境检测测试
2. 特性检测测试
3. 能力评估测试
4. 配置推荐测试
5. 降级策略测试

## 后续优化方向

1. **机器学习增强**：收集更多数据，使用机器学习优化推荐算法
2. **地理位置感知**：基于地理位置优化网络策略
3. **历史数据分析**：利用历史上传数据优化推荐
4. **更精细的设备分类**：增加更多设备类型和特征检测

## 总结

环境检测系统升级极大地增强了 fileChunkPro 的智能化水平，使其能够根据不同环境自动调整最佳配置，提高上传性能和成功率。这一系统是实现真正跨平台、自适应上传体验的关键基础设施。

通过这套系统，开发者不再需要手动为不同环境配置参数，fileChunkPro 会根据当前环境和文件特性自动选择最优设置，实现"即插即用"的便捷体验。
