# 错误处理系统重构建议

## 当前问题

经过对error目录下的文件进行分析，发现以下问题：

1. **功能重叠**：`ErrorCenter.ts`和`ErrorHandlingSystem.ts`存在大量功能重叠：

   - 都提供错误处理、记录和恢复等核心功能
   - 都有错误统计和缓存机制
   - 都依赖`ErrorRecoveryManager`进行错误恢复
   - 都实现了网络质量监控相似功能

2. **代码冗余**：`ErrorCenter.ts`有635行，`ErrorHandlingSystem.ts`有513行，功能高度相似却维护两套系统。

3. **职责不清**：一个项目不应该有两个中心化的错误处理系统，造成使用混乱。

4. **架构不一致**：`ErrorHandlingSystem`采用单例模式，而`ErrorCenter`则通过依赖注入`EventBus`。

## 优化建议

### 1. 统一错误处理中心

合并`ErrorCenter`和`ErrorHandlingSystem`为一个统一的错误处理中心，采用单例模式，保留最有价值的功能：

- 以`ErrorCenter`作为核心统一类，但采用`ErrorHandlingSystem`的单例模式设计
- 保留更完善的错误处理策略和类型检测机制
- 统一错误缓存和统计方式

### 2. 模块拆分

将现在的`ErrorCenter.ts`根据职责拆分为更小的模块：

#### `ErrorCenter.ts`（核心模块，200-300行）

- 错误处理核心功能
- 错误事件分发
- 模块初始化和协调

#### `ErrorContext.ts`（100-150行）

- 错误上下文收集
- 环境信息提取
- 网络状态监控

#### `ErrorStorage.ts`（100-150行）

- 错误缓存实现
- 错误统计和检索
- 错误持久化存储

#### `ErrorTelemetry.ts`（100-150行）

- 错误远程上报
- 数据打点功能
- 数据脱敏处理

### 3. 代码组织优化

1. 在`index.ts`中统一导出所有模块，简化引用
2. 使用组合而非继承设计错误处理模块
3. 抽象出共用工具函数到单独的辅助文件

## 迁移策略

1. 创建新的模块结构
2. 实现新的`ErrorCenter`单例
3. 提供兼容层以支持平滑迁移
4. 在较长过渡期后废弃旧实现

## 改进收益

1. 代码量减少约40%
2. 消除维护两套系统的混乱
3. 提高可测试性和扩展性
4. 各模块职责更加明确
